<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
    <style>
        .origin_circle {
            fill: black;
            stroke: black;
            stroke-width: 0.7;
            opacity: 0.5;
        }
        .dest_circle {
            fill: whitesmoke;
            stroke: black;
            stroke-width: 0.7;
            opacity: 0.5;
        }
    </style>
    <script type="text/javascript">  
        function draw(geo_data) {
            "use strict";
            var margin = 75,
                width = 1400 - margin,
                height = 600 - margin;

            var svg = d3.select("body")
                .append("svg")
                .attr("width", width + margin)
                .attr("height", height + margin)
                .append('g')
                .attr('class', 'map');

            var projection = d3.geo.mercator()
                                .scale(400)
                                .translate([width/.95, height/0.7]);
            
            var path = d3.geo.path().projection(projection);

            var map = svg.selectAll('path')
                        .data(geo_data.features)
                        .enter()
                        .append('path')
                        .attr('d', path)
                        .style('fill', 'lightBlue')
                        .style('stroke', 'black')
                        .style('stroke-width', 0.5);
            
            function plot_points(data) {
                function agg_year(leaves) {
                    var orig_coords = leaves.map(function (d) {
                        return projection([+d.long_Origin, +d.lat_Origin]);
                    });

                    var dest_coords = leaves.map(function (d) {
                        return projection([+d.long_Dest, +d.lat_Dest]);
                    });

                    var origin_x = d3.mean(orig_coords, function(d) {
                        return d[0];
                    });

                    var origin_y = d3.mean(orig_coords, function(d) {
                        return d[1];
                    });
                    
                    var dest_x = d3.mean(dest_coords, function(d) {
                        return d[0];
                    });
                    
                    var dest_y = d3.mean(dest_coords, function(d) {
                        return d[1];
                    });

                    return {
                        'origin_x' : orig_coords,
                        'origin_y' : orig_coords,
                        'dest_x' : dest_x,
                        'dest_y' : dest_y
                    };
                }

                var nested = d3.nest()
                               .key(function(d){
                                   return d['DepDateTime'].getUTCDay();
                               })
                               .rollup(agg_year)
                               .entries(data)
                
                //debugger;
                
                svg.append('g')
                   .attr('class','bubble')
                   .selectAll('circle')
                   .data(data)
                   .enter()
                   .append('circle')
                   .attr('cx', function(d) {return projection([+d.long_Origin, +d.lat_Origin])[0]; })
                   .attr('cy', function(d) {return projection([+d.long_Origin, +d.lat_Origin])[1]; })
                   .attr('r',5)
                   .attr('class','origin_circle');
                
                svg.append('g')
                   .attr('class','bubble')
                   .selectAll('circle')
                   .data(data)
                   .enter()
                   .append('circle')
                   .attr('cx', function(d) {return projection([+d.long_Dest, +d.lat_Dest])[0]; })
                   .attr('cy', function(d) {return projection([+d.long_Dest, +d.lat_Dest])[1]; })
                   .attr('r',5)
                   .attr('class','dest_circle');

            }

        var format = d3.time.format('%Y-%m-%d')

        d3.csv('data/2008_01.csv', function (d) {
            d['DepDateTime'] = format.parse(d['DepDateTime']);
            return d;
        }, plot_points)

      };
      </script>
  </head>
<body>
  <script type="text/javascript">
  /*
    Use D3 to load the GeoJSON file
    */
    
d3.json("data/usa.json", draw);
  </script>
</body>
</html>