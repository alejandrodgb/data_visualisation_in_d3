<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
    <style>
    </style>
    <script type="text/javascript">  
      function draw(geo_data) {
        "use strict";
        var margin = 75,
            width = 1400 - margin,
            height = 600 - margin;

        var svg = d3.select("body")
            .append("svg")
            .attr("width", width + margin)
            .attr("height", height + margin)
            .append('g')
            .attr('class', 'map');
        
        // return the x and y pixel given the coordiate of lat and lon
        var projection = d3.geo.mercator()
                            .scale(150)
                            .translate([width/2, height/1.5]);      
        
        // create the polygon that will be appended to svg object
        var path = d3.geo.path().projection(projection);
        
        var map = svg.selectAll('path')
                    .data(geo_data.features)
                    .enter()
                    .append('path')
                    .attr('d',path)
                    .style('fill','lightBlue')
                    .style('stroke','black')
                    .style('storke-width',0.5);

        function plot_points(data) {
          debugger;
          // draw circles logic - gorup games by year they were held
          
          function agg_year(leaves){
            var total = d3.sum(leaves,function(d){
              return d['attendance'];
            });
    
            // projection maps lat and lon to pixels in the page
            var coord = leaves.map(function (d) {
              return projection([+d.long, +d.lat]);
            });
            
            // get the average value of all games for a given world cup year
            var center_x = d3.mean(coord, function(d) {
              return d[0];
            });
            var center_y = d3.mean(coord, function(d){
              return d[1];
            });

            // return values from the rollup  
            return {
              'attendance': total,
              'x': center_x,
              'y': center_y
            };
          };

          var nested = d3.nest()
            // value the data will be grouped by
            .key(function(d) {
              //debugger;
              return d['date'].getUTCFullYear();
            })
            // aggregation
            .rollup(agg_year)
            // pass the data through all the transforms
            .entries(data);
            
          // getting the range of the data  
          var attendance_extent = d3.extent(nested, function(d){
            return d.values['attendance'];
          });
          
          // create the scale from attendance to pixels
          var radius = d3.scale.sqrt()
            .domain(attendance_extent)
            .range([0,12]);

          svg.append('g')
            .attr('class','bubble')
            .selectAll('circle')
            .data(nested.sort(function(a,b){
              return b.values['attendance']-a.values['attendance'];
            }))
            .enter()
            .append('circle')
            .attr('cx',function(d){
              return d.values['x'];
            })
            .attr('cy',function(d){
              return d.values['y'];
            })
            .attr('r',function(d) {
              return radius(d.values['attendance']);
            })
            .attr('fill','rgb(247,148,32)')
            .attr('stroke','black')
            .attr('stroke-width', 0.7)
            .attr('opacity',0.7);
        };

        var format = d3.time.format('%d-%m-%Y (%H:%M h)');

        d3.tsv('../Data_Vis_Complete_Code_Files/lesson4/world_cup_geo.tsv',function(d){
                d['attendance']=+d['attendance'];
                d['date']=format.parse(d['date']);
                return d;
              }, plot_points);
      };
      </script>
  </head>
<body>
  <script type="text/javascript">
  /*
    Use D3 to load the GeoJSON file
    */
    
  d3.json("../Data_Vis_Complete_Code_Files/lesson4/world_countries.json", draw);
  </script>
</body>
</html>
